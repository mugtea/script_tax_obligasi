USE [Enginestatement_BDI]
GO


CREATE OR ALTER PROCEDURE [dbo].[TaxCustomerDeductedAdvice_OBS_Syariah_CustomerInformation_Insert] AS BEGIN IF EXISTS (    
  SELECT    
    TOP 1 *    
  FROM    
    TaxCustomerDeductedAdvice_OBS_StagingData    
) BEGIN    
TRUNCATE TABLE TaxCustomerDeductedAdvice_OBS_Syariah_CustomerInformation  
INSERT INTO    
  TaxCustomerDeductedAdvice_OBS_Syariah_CustomerInformation (    
    cif,    
    customer_name,    
    account_no,    
    branch_code,    
    postal_code ,
	fk_taxrequestlist
  )    
SELECT DISTINCT    
  E.cif,    
  E.customer_name,    
  E.account_no,    
  E.branch_code,    
  TRL.id postal_code,
  TRL.id as FK_TaxRequestList
FROM    
  TaxCustomerDeductedAdvice_OBS_StagingData e    
  INNER JOIN TaxRequestList TRL ON TRL.CIF=E.cif
  INNER JOIN TaxCustomerDeductedAdvice_OBS_Summary CSR ON CSR.fk_taxrequestlist = TRL.id and e.account_no = csr.ACCOUNT_NO
WHERE trl.[status] = 'waiting' and CSR.product_category LIKE '%syariah%'  
AND     
  NOT EXISTS (    
    SELECT    
      NULL    
    FROM    
      TaxCustomerDeductedAdvice_OBS_Syariah_CustomerInformation d    
    WHERE    
      d.cif=e.cif    
      AND d.account_no=e.account_no    
   AND trl.[Status] = 'waiting'    
  )
  END
  END
GO


